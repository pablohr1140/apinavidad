// # schema
// Propósito: Esquema/consulta schema
// Pertenece a: Prisma
// Interacciones: Base de datos

// schema.prisma
// Propósito: definir el modelo relacional para SQL Server y generar el cliente Prisma.
// Responsabilidades: mapear tablas existentes (via @map/@@map), configurar datasource y generator.
// Interacciones: usado por `PrismaService` en Nest; las migraciones/DDL dependen de este esquema.
// Notas SQL Server: columnas BigInt se devuelven como JS BigInt; los repos convierten a Number en `toDomain`.
// Pertenece a: capa de infraestructura (ORM/cliente de datos).

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "sqlserver"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model discapacidad_nino {
  id              Int            @id(map: "PK_discapacidad_nino") @default(autoincrement())
  nino_id         BigInt
  discapacidad_id Int
  porcentaje      Int?           @db.TinyInt
  descripcion     String?        @db.NVarChar(Max)
  created_at      DateTime       @default(dbgenerated("sysdatetime()"), map: "DF_discapacidad_nino_created_at")
  updated_at      DateTime       @default(dbgenerated("sysdatetime()"), map: "DF_discapacidad_nino_updated_at")
  discapacidades  discapacidades @relation(fields: [discapacidad_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_discapacidad_nino_discapacidades")
  ninos           ninos          @relation(fields: [nino_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_discapacidad_nino_ninos")

  @@unique([nino_id, discapacidad_id], map: "UQ_discapacidad_nino_pair")
}

model discapacidades {
  id                Int                 @id(map: "PK_discapacidades") @default(autoincrement())
  nombre            String              @unique(map: "UQ_discapacidades_nombre") @db.NVarChar(255)
  activo            Boolean             @default(true, map: "DF_discapacidades_activo")
  created_at        DateTime            @default(dbgenerated("sysdatetime()"), map: "DF_discapacidades_created_at")
  updated_at        DateTime            @default(dbgenerated("sysdatetime()"), map: "DF_discapacidades_updated_at")
  discapacidad_nino discapacidad_nino[]
}

model etnias {
  id          Int      @id(map: "PK_etnias") @default(autoincrement())
  nombre      String   @unique(map: "UQ_etnias_nombre") @db.NVarChar(255)
  codigo      String?  @db.NVarChar(10)
  descripcion String?  @db.NVarChar(500)
  activo      Boolean  @default(true, map: "DF_etnias_activo")
  created_at  DateTime @default(dbgenerated("sysdatetime()"), map: "DF_etnias_created_at")
  updated_at  DateTime @default(dbgenerated("sysdatetime()"), map: "DF_etnias_updated_at")
}

model logs {
  id            Int       @id(map: "PK_logs") @default(autoincrement())
  user_id       Int?
  accion        String    @db.NVarChar(150)
  mensaje       String?   @db.NVarChar(Max)
  loggable_type String    @db.NVarChar(150)
  loggable_id   BigInt
  payload       String?   @db.NVarChar(Max)
  ip            String?   @db.NVarChar(100)
  user_agent    String?   @db.NVarChar(300)
  created_at    DateTime  @default(dbgenerated("sysdatetime()"), map: "DF_logs_created_at")
  updated_at    DateTime  @default(dbgenerated("sysdatetime()"), map: "DF_logs_updated_at")
  personas      personas? @relation(fields: [user_id], references: [id], onUpdate: NoAction, map: "FK_logs_personas")

  @@index([accion], map: "IX_logs_accion")
  @@index([loggable_type, loggable_id], map: "IX_logs_loggable")
}

model migrations {
  id        Int    @id(map: "PK_8c82d7f526340ab734260ea46be") @default(autoincrement())
  timestamp BigInt
  name      String @db.VarChar(255)
}

model nacionalidades {
  id         Int      @id(map: "PK_nacionalidades") @default(autoincrement())
  nombre     String   @unique(map: "UQ_nacionalidades_nombre") @db.NVarChar(255)
  iso        String?  @db.NVarChar(3)
  gentilicio String?  @db.NVarChar(120)
  activo     Boolean  @default(true, map: "DF_nacionalidades_activo")
  created_at DateTime @default(dbgenerated("sysdatetime()"), map: "DF_nacionalidades_created_at")
  updated_at DateTime @default(dbgenerated("sysdatetime()"), map: "DF_nacionalidades_updated_at")

  ninos ninos[]
}

model ninos {
  id                  BigInt              @id(map: "PK_ninos") @default(autoincrement())
  nombres             String              @db.NVarChar(200)
  apellidos           String?             @db.NVarChar(200)
  documento_numero    String              @db.NVarChar(50)
  tipo_documento_id   Int?
  nacionalidad_id     Int?
  persona_registro_id Int?
  fecha_nacimiento    DateTime?           @db.Date
  sexo                String?             @db.NVarChar(1)
  organizacion_id     BigInt?
  periodo_id          Int
  es_prioritario      Boolean             @default(false)
  edad                Int?                @db.TinyInt
  tiene_discapacidad  Boolean             @default(false, map: "DF_ninos_tiene_discapacidad")
  fecha_ingreso       DateTime?           @db.Date
  fecha_retiro        DateTime?           @db.Date
  estado              Boolean             @default(true, map: "DF_ninos_estado_bit") @db.Bit
  created_at          DateTime            @default(dbgenerated("sysdatetime()"), map: "DF_ninos_created_at")
  updated_at          DateTime            @default(dbgenerated("sysdatetime()"), map: "DF_ninos_updated_at")
  discapacidad_nino   discapacidad_nino[]
  organizaciones      organizaciones?     @relation(fields: [organizacion_id], references: [id], onUpdate: NoAction, map: "FK_ninos_organizaciones")
  periodos            periodos            @relation(fields: [periodo_id], references: [id], onUpdate: NoAction, map: "FK_ninos_periodos")
  tipo_documentos     tipo_documentos?    @relation(fields: [tipo_documento_id], references: [id], onUpdate: NoAction, map: "FK_ninos_tipo_documentos")
  nacionalidades      nacionalidades?     @relation(fields: [nacionalidad_id], references: [id], onUpdate: NoAction, map: "FK_ninos_nacionalidades")
  personas            personas?           @relation("ninos_persona_registro_idTopersonas", fields: [persona_registro_id], references: [id], onUpdate: NoAction, map: "FK_ninos_personas_registro")

  @@unique([tipo_documento_id, documento_numero], map: "UQ_ninos_doc_tipo_numero")
  @@index([estado, periodo_id], map: "IX_ninos_estado_periodo")
}

model organizacion_periodo {
  id               Int            @id(map: "PK_organizacion_periodo") @default(autoincrement())
  organizacion_id  BigInt
  periodo_id       Int
  estado           String         @default("pendiente", map: "DF_organizacion_periodo_estado") @db.NVarChar(50)
  fecha_asignacion DateTime?      @db.Date
  fecha_cierre     DateTime?      @db.Date
  observaciones    String?        @db.NVarChar(Max)
  created_at       DateTime       @default(dbgenerated("sysdatetime()"), map: "DF_organizacion_periodo_created_at")
  updated_at       DateTime       @default(dbgenerated("sysdatetime()"), map: "DF_organizacion_periodo_updated_at")
  organizaciones   organizaciones @relation(fields: [organizacion_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_organizacion_periodo_organizaciones")
  periodos         periodos       @relation(fields: [periodo_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_organizacion_periodo_periodos")

  @@unique([organizacion_id, periodo_id], map: "UQ_organizacion_periodo_pair")
}

model organizacion_persona {
  id                  Int            @id(map: "PK_organizacion_persona") @default(autoincrement())
  organizacion_id     BigInt
  persona_id          Int
  es_principal        Boolean        @default(false, map: "DF_organizacion_persona_es_principal")
  es_reserva          Boolean        @default(false, map: "DF_organizacion_persona_es_reserva")
  activo              Boolean        @default(true, map: "DF_organizacion_persona_activo")
  fecha_asignacion    DateTime?      @db.Date
  fecha_desactivacion DateTime?      @db.Date
  observaciones       String?        @db.NVarChar(Max)
  created_at          DateTime       @default(dbgenerated("sysdatetime()"), map: "DF_organizacion_persona_created_at")
  updated_at          DateTime       @default(dbgenerated("sysdatetime()"), map: "DF_organizacion_persona_updated_at")
  organizaciones      organizaciones @relation(fields: [organizacion_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_organizacion_persona_organizaciones")
  personas            personas       @relation(fields: [persona_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_organizacion_persona_personas")

  @@unique([organizacion_id, persona_id], map: "UQ_organizacion_persona_pair")
  @@index([organizacion_id, es_principal], map: "IX_organizacion_persona_principal")
}

model organizaciones {
  id                   BigInt                 @id(map: "PK_organizaciones") @default(autoincrement())
  nombre               String                 @unique(map: "UQ_organizaciones_nombre") @db.NVarChar(250)
  sigla                String?                @db.NVarChar(50)
  rut                  String?                @db.NVarChar(12)
  tipo                 String                 @default("otro", map: "DF_organizaciones_tipo") @db.NVarChar(100)
  direccion            String?                @db.NVarChar(300)
  telefono             String?                @db.NVarChar(20)
  email                String?                @db.NVarChar(320)
  providencia_id       Int?
  estado               String                 @default("borrador", map: "DF_organizaciones_estado") @db.NVarChar(50)
  created_at           DateTime               @default(dbgenerated("sysdatetime()"), map: "DF_organizaciones_created_at")
  updated_at           DateTime               @default(dbgenerated("sysdatetime()"), map: "DF_organizaciones_updated_at")
  ninos                ninos[]
  organizacion_periodo organizacion_periodo[]
  organizacion_persona organizacion_persona[]
  providencias         providencias?          @relation(fields: [providencia_id], references: [id], onUpdate: NoAction, map: "FK_organizaciones_providencias")

  @@index([estado], map: "IX_organizaciones_estado")
}

model periodos {
  id                   Int                    @id(map: "PK_periodos") @default(autoincrement())
  nombre               String                 @unique(map: "UQ_periodos_nombre") @db.NVarChar(200)
  fecha_inicio         DateTime?              @db.Date
  fecha_fin            DateTime?              @db.Date
  estado_periodo       String                 @default("borrador", map: "DF_periodos_estado_periodo") @db.NVarChar(50)
  es_activo            Boolean                @default(false, map: "DF_periodos_es_activo")
  descripcion          String?                @db.NVarChar(Max)
  created_at           DateTime               @default(dbgenerated("sysdatetime()"), map: "DF_periodos_created_at")
  updated_at           DateTime               @default(dbgenerated("sysdatetime()"), map: "DF_periodos_updated_at")
  ninos                ninos[]
  organizacion_periodo organizacion_periodo[]
}

model permissions {
  id               Int                @id(map: "PK_permissions") @default(autoincrement())
  resource         String             @db.NVarChar(50)
  action           String             @db.NVarChar(50)
  description      String?            @db.NVarChar(255)
  created_at       DateTime           @default(dbgenerated("sysdatetime()"), map: "DF_permissions_created_at")
  updated_at       DateTime           @default(dbgenerated("sysdatetime()"), map: "DF_permissions_updated_at")
  role_permissions role_permissions[]

  @@unique([resource, action], map: "UQ_permissions_resource_action")
}

model personas {
  id                   Int                    @id(map: "PK_personas") @default(autoincrement())
  nombres              String                 @db.NVarChar(200)
  apellidos            String                 @db.NVarChar(200)
  run                  String?                @db.NVarChar(12)
  dv                   String?                @db.NVarChar(2)
  fecha_nacimiento     DateTime?              @db.Date
  sexo                 String?                @db.NVarChar(1)
  telefono             String?                @db.NVarChar(20)
  email                String?                @db.NVarChar(320)
  email_verified_at    DateTime?
  password             String?                @db.NVarChar(255)
  remember_token       String?                @db.NVarChar(100)
  direccion            String?                @db.NVarChar(300)
  providencia_id       Int?
  role_id              Int?
  es_representante     Boolean                @default(false, map: "DF_personas_es_representante")
  created_at           DateTime               @default(dbgenerated("sysdatetime()"), map: "DF_personas_created_at")
  updated_at           DateTime               @default(dbgenerated("sysdatetime()"), map: "DF_personas_updated_at")
  logs                 logs[]
  organizacion_persona organizacion_persona[]
  providencias         providencias?          @relation(fields: [providencia_id], references: [id], onUpdate: NoAction, map: "FK_personas_providencias")
  roles                roles?                 @relation(fields: [role_id], references: [id], onUpdate: NoAction, map: "FK_personas_roles")
  ninos_registrados    ninos[]                @relation("ninos_persona_registro_idTopersonas")

  @@index([nombres, apellidos], map: "IX_personas_nombres_apellidos")
}

model providencias {
  id             Int              @id(map: "PK_providencias") @default(autoincrement())
  nombre         String           @unique(map: "UQ_providencias_nombre") @db.NVarChar(255)
  codigo         String?          @db.NVarChar(10)
  region         String?          @db.NVarChar(150)
  comuna         String?          @db.NVarChar(150)
  descripcion    String?          @db.NVarChar(Max)
  activo         Boolean          @default(true, map: "DF_providencias_activo")
  created_at     DateTime         @default(dbgenerated("sysdatetime()"), map: "DF_providencias_created_at")
  updated_at     DateTime         @default(dbgenerated("sysdatetime()"), map: "DF_providencias_updated_at")
  organizaciones organizaciones[]
  personas       personas[]
}

model role_permissions {
  role_id       Int
  permission_id Int
  permissions   permissions @relation(fields: [permission_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_role_permissions_permissions")
  roles         roles       @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_role_permissions_roles")

  @@id([role_id, permission_id], map: "PK_role_permissions")
}

model roles {
  id               Int                @id(map: "PK_roles") @default(autoincrement())
  role_key         String             @unique(map: "UQ_roles_key") @db.NVarChar(50)
  name             String             @db.NVarChar(120)
  description      String?            @db.NVarChar(255)
  rank             Int
  created_at       DateTime           @default(dbgenerated("sysdatetime()"), map: "DF_roles_created_at")
  updated_at       DateTime           @default(dbgenerated("sysdatetime()"), map: "DF_roles_updated_at")
  role_permissions role_permissions[]
  personas         personas[]
}

model tipo_documentos {
  id          Int      @id(map: "PK_tipo_documentos") @default(autoincrement())
  nombre      String   @unique(map: "UQ_tipo_documentos_nombre") @db.NVarChar(255)
  codigo      String   @unique(map: "UQ_tipo_documentos_codigo") @db.NVarChar(10)
  descripcion String?  @db.NVarChar(500)
  activo      Boolean  @default(true, map: "DF_tipo_documentos_activo")
  created_at  DateTime @default(dbgenerated("sysdatetime()"), map: "DF_tipo_documentos_created_at")
  updated_at  DateTime @default(dbgenerated("sysdatetime()"), map: "DF_tipo_documentos_updated_at")

  ninos ninos[]
}
